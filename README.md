import pandas as pd

# --- 1. Загружаем справочник ---
df_ref = pd.read_excel("shtatka_go.xlsx")

# --- 2. Нормализуем табельный номер / сотрудника ---
# важно: приводим к строке, убираем пробелы и всё, что ломает сопоставление
df["Сотрудник"] = normalize_tab(df["Сотрудник"].astype(str))
df_ref["ТабНомер"] = normalize_tab(df_ref["ТабНомер"].astype(str))

# --- 3. Приводим даты ---
df["Календарный день"] = pd.to_datetime(
    df["Календарный день"], errors="coerce", dayfirst=True
)

df_ref["ДатаНазнНаДолжность"] = pd.to_datetime(
    df_ref["ДатаНазнНаДолжность"], errors="coerce", dayfirst=True
)
df_ref["ДатаУвольнения"] = pd.to_datetime(
    df_ref["ДатаУвольнения"], errors="coerce", dayfirst=True
)

# --- 4. Заполняем пустые даты диапазонами ---
min_date = pd.Timestamp("1900-01-01")
max_date = pd.Timestamp("2099-12-31")

# Если дата назначения пустая — считаем, что сотрудник работал "с самого начала"
df_ref["ДатаНазнНаДолжность"] = df_ref["ДатаНазнНаДолжность"].fillna(min_date)

# Если увольнения нет — сотрудник ещё работает
df_ref["ДатаУвольнения"] = df_ref["ДатаУвольнения"].fillna(max_date)

# опционально: чистка названий подразделений в самом df_ref,
# а не в отдельном df_ref_sp
df_ref["Подразд-е уровень 2"] = clean_str(df_ref["Подразд-е уровень 2"])
df_ref["Подразд-е уровень 3"] = clean_str(df_ref["Подразд-е уровень 3"])

# --- 5. Оставляем только нужные поля из справочника ---
ref_keep = [
    "ТабНомер",
    "ДатаНазнНаДолжность",
    "ДатаУвольнения",
    "Подразд-е уровень 2",
    "Подразд-е уровень 3",
]
df_ref = df_ref[ref_keep].copy()

# --- 6. Добавляем уникальный row_id для df ---
df = df.reset_index(drop=True)
df["row_id"] = df.index

# --- 7. Мердж по табельному номеру/сотруднику ---
merged = df.merge(
    df_ref,
    how="left",
    left_on="Сотрудник",
    right_on="ТабНомер",
    suffixes=("", "_ref"),
)

# Быстрая диагностика: сколько вообще совпало по табельному
print("Совпало по табельному номеру:", merged["ТабНомер"].notna().sum())

# --- 8. Фильтруем только записи, попадающие в диапазон дат ---
mask = (
    (merged["Календарный день"] >= merged["ДатаНазнНаДолжность"])
    & (merged["Календарный день"] <= merged["ДатаУвольнения"])
)

print("Совпало и по табельному, и по диапазону дат:", mask.sum())

candidates = merged.loc[
    mask, ["row_id", "Подразд-е уровень 2", "Подразд-е уровень 3"]
].copy()

# если у сотрудника несколько назначений, берём последнее по датам
# (для этого в исходном df_ref должны быть отсортированы по дате,
# но мы уже заполнили пустые минимальной датой, так что всё ок)
candidates = candidates.drop_duplicates(subset="row_id", keep="last")
candidates = candidates.set_index("row_id")

# --- 9. Джойним результат обратно к df ---
df = df.join(candidates, on="row_id")

print("-- добавление СП2/СП3 завершено. Обновлено строк:", candidates.shape[0])
