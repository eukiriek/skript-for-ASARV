import pandas as pd
import numpy as np

# df: Имя | Вид события | Время | Дата

# 1. Нормализуем тип события (убираем пробелы, приводим к нижнему регистру)
df['Вид события_норм'] = df['Вид события'].str.strip().str.lower()

# 2. Приводим дату и время к удобному формату
df['Дата'] = pd.to_datetime(df['Дата'], dayfirst=True)       # дд.мм.гггг
df['Время_td'] = pd.to_timedelta(df['Время'])                # чч:мм:сс

# 3. Сортируем по сотруднику, дате и времени
df = df.sort_values(['Имя', 'Дата', 'Время_td'])

# 4. Берём предыдущее событие ВНУТРИ одного сотрудника и одного дня
df['prev_time']  = df.groupby(['Имя', 'Дата'])['Время_td'].shift(1)
df['prev_event'] = df.groupby(['Имя', 'Дата'])['Вид события_норм'].shift(1)

# 5. Считаем разницу ТОЛЬКО для строк, где текущий событие - "уход",
#    а предыдущее событие в этом дне для этого сотрудника - "приход"
mask = (
    (df['Вид события_норм'] == 'уход') &
    (df['prev_event'] == 'приход')
)

df['Разница_приход_уход'] = pd.NaT
df.loc[mask, 'Разница_приход_уход'] = df.loc[mask, 'Время_td'] - df.loc[mask, 'prev_time']

# Если нужно именно в формате "чч:мм:сс" (как текст):
df['Разница_чч:мм:сс'] = df['Разница_приход_уход'].astype('timedelta64[s]').astype('Int64')
df['Разница_чч:мм:сс'] = df['Разница_чч:мм:сс'].apply(
    lambda x: pd.to_timedelta(x, unit='s') if pd.notna(x) else pd.NaT
).astype(str)
