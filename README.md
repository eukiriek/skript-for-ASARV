# 7. Коррекция отрицательных значений,
#    если Отработанное время больше, чем (Время выхода - Время входа)

# маска: Новое отработанное время отрицательное
mask_neg = (
    df["Новое отработанное время"].notna()
    & (df["Новое отработанное время"] < pd.Timedelta(0))
)

# "сырое" отработанное по разнице выход - вход
raw_work_fix = df["Время выхода"] - df["Время входа"]

# маска: Отработанное время больше, чем разница выход - вход
mask_gt_raw = df["Отработанное время"] > raw_work_fix

# итоговая маска для пересчёта
mask_fix = mask_neg & mask_gt_raw

# максимум из "Время отсутствия" и "Время обеда"
max_break_fix = (
    df.loc[mask_fix, ["Время отсутствия", "Время обеда"]]
      .max(axis=1)
      .fillna(pd.Timedelta(0))
)

# пересчёт Нового отработанного времени:
# 24 часа - время входа + время выхода - max(отсутствие, обед)
df.loc[mask_fix, "Новое отработанное время"] = (
    pd.Timedelta(hours=24)
    - (df.loc[mask_fix, "Время входа"]
       - df.loc[mask_fix, "Время входа"].dt.normalize())
    + (df.loc[mask_fix, "Время выхода"]
       - df.loc[mask_fix, "Время выхода"].dt.normalize())
    - max_break_fix
)
