# 7. Коррекция отрицательных значений при длинных сменах (>20 часов)

# маска: новое отработанное время отрицательное
mask_neg = (
    df["Новое отработанное время"].notna()
    & (df["Новое отработанное время"] < pd.Timedelta(0))
)

# маска: исходное отработанное время > 20 часов
mask_long = df["Отработанное время"] > pd.Timedelta(hours=20)

# итоговая маска для пересчёта
mask_fix = mask_neg & mask_long

# максимум из "Время отсутствия" и "Время обеда" для этих строк
max_break_fix = (
    df.loc[mask_fix, ["Время отсутствия", "Время обеда"]]
      .max(axis=1)
      .fillna(pd.Timedelta(0))
)

# пересчёт нового отработанного времени:
# 24 часа - время входа + время выхода - max(отсутствие, обед)
df.loc[mask_fix, "Новое отработанное время"] = (
    pd.Timedelta(hours=24)
    - (df.loc[mask_fix, "Время входа"] - df.loc[mask_fix, "Время входа"].dt.normalize())
    + (df.loc[mask_fix, "Время выхода"] - df.loc[mask_fix, "Время выхода"].dt.normalize())
    - max_break_fix
)
