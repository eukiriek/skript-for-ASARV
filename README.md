import pandas as pd

# --- чтение файлов с отпусками и доп. днями ---
df_otpusk = pd.read_excel("otpusk.xlsx")                       # колонки: Табельный номер | Всего
df_sprav = pd.read_excel("spravochnik.xlsx", sheet_name="add_vac")  # Табельный номер | ДопДни | Северные

# --- приведение табельных номеров к одному типу ---
df["Таб Номер"] = df["Таб Номер"].astype(str)
df_otpusk["Табельный номер"] = df_otpusk["Табельный номер"].astype(str)
df_sprav["Табельный номер"] = df_sprav["Табельный номер"].astype(str)

# --- подготовка мапов с УНИКАЛЬНЫМ индексом по табельному номеру ---
# файл otpusk: суммируем «Всего» по каждому табельному
otpusk_map = (
    df_otpusk
    .groupby("Табельный номер", as_index=True)["Всего"]
    .sum()
)

# файл spravochnik: считаем доп. дни (ДопДни + Северные) и тоже агрегируем по табельному
df_sprav[["ДопДни", "Северные"]] = df_sprav[["ДопДни", "Северные"]].fillna(0)
df_sprav["доп_все"] = df_sprav["ДопДни"] + df_sprav["Северные"]

sprav_map = (
    df_sprav
    .groupby("Табельный номер", as_index=True)["доп_все"]
    .sum()
)

# --- базовое поле в основном df ---
df["Накопленные дни отпуска"] = 0

# маски по стажу
mask_180_730 = (df["Стаж, дни"] > 180) & (df["Стаж, дни"] < 731)
mask_731_plus = df["Стаж, дни"] >= 731

# 1) если стаж > 180 и < 731 — переносим данные из otpusk.xlsx
df.loc[mask_180_730, "Накопленные дни отпуска"] = (
    df.loc[mask_180_730, "Таб Номер"].map(otpusk_map)
)

# 2) если стаж >= 731 — накопленные дни = (24 + ДопДни + Северные) * 2
df.loc[mask_731_plus, "Накопленные дни отпуска"] = (
    24 + df.loc[mask_731_plus, "Таб Номер"].map(sprav_map)
) * 2

# если где-то ничего не нашлось — ставим 0
df["Накопленные дни отпуска"] = df["Накопленные дни отпуска"].fillna(0)

# сохранение результата
df.to_excel("burnout_rate.xlsx", index=False)
